name: Sync QCA Upstream and Apply Modifications

on:
  workflow_dispatch: {}  # æ‰‹åŠ¨è§¦å‘ï¼šå¼ºåˆ¶æ‰§è¡Œ
  schedule:
    - cron: '0 16 * * *'  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©UTC 16:00ï¼ˆåŒ—äº¬æ—¶é—´ 00:00ï¼‰
  push:
    branches:
      - main
    paths:
      - '.github/workflows/Sync QCA Upstream and Apply Modifications.yml'  # ä»…å½“æ­¤æ–‡ä»¶å˜åŒ–æ—¶è§¦å‘

permissions:
  contents: write
  actions: write

jobs:
  sync-and-modify:
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN != '' && secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set up upstream remote
        run: |
          git remote add upstream https://github.com/VIKINGYFY/OpenWRT-CI.git 2>/dev/null || true
          git remote -v

      - name: Fetch upstream and origin branches
        run: |
          echo "æ­£åœ¨ä»ä¸Šæ¸¸ä¸ origin æ‹‰å–æœ€æ–°åˆ†æ”¯..."
          git fetch upstream main --prune
          git fetch origin main --prune

      - name: æ‰‹åŠ¨è§¦å‘æç¤º
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "::notice::æ‰‹åŠ¨è§¦å‘æ‰§è¡Œ - å°†å¼ºåˆ¶åŒæ­¥ä¸Šæ¸¸å¹¶åº”ç”¨è‡ªå®šä¹‰ä¿®æ”¹"

      - name: Check for upstream updates
        id: check_updates
        run: |
          UPSTREAM_REF="refs/remotes/upstream/main"
          ORIGIN_REF="refs/remotes/origin/main"

          UPSTREAM_HEAD=$(git rev-parse --verify ${UPSTREAM_REF} 2>/dev/null || echo "")
          ORIGIN_HEAD=$(git rev-parse --verify ${ORIGIN_REF} 2>/dev/null || echo "")

          echo "ä¸Šæ¸¸ HEAD: $UPSTREAM_HEAD"
          echo "origin/main HEAD: $ORIGIN_HEAD"

          if [ -z "$UPSTREAM_HEAD" ]; then
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "::warning::æ— æ³•è¯»å– upstream/main å¼•ç”¨"
            exit 0
          fi

          COMMITS_AHEAD=$(git rev-list --count ${ORIGIN_REF}..${UPSTREAM_REF} 2>/dev/null || echo 0)
          echo "ä¸Šæ¸¸ç›¸å¯¹äº origin/main æ–°å¢æäº¤æ•°: $COMMITS_AHEAD"

          if [ "$COMMITS_AHEAD" -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "::notice::å‘ç°ä¸Šæ¸¸æ–°æäº¤ï¼ˆ${COMMITS_AHEAD} ä¸ªï¼‰"
            echo "æœ€æ–°çš„ä¸Šæ¸¸æäº¤ï¼š"
            git --no-pager log --oneline ${ORIGIN_REF}..${UPSTREAM_REF} --max-count=5 || true
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "::notice::ä¸Šæ¸¸æ— æ–°æäº¤ï¼Œæ— éœ€åŒæ­¥"
          fi

      - name: Determine if should proceed
        id: should_proceed
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
            echo "::notice::æ‰‹åŠ¨è§¦å‘ - å¼ºåˆ¶æ‰§è¡Œ"
          elif [ "${{ steps.check_updates.outputs.has_updates }}" = "true" ]; then
            echo "proceed=true" >> $GITHUB_OUTPUT
            echo "::notice::æ£€æµ‹åˆ°ä¸Šæ¸¸æ›´æ–° - å¼€å§‹åŒæ­¥"
          else
            echo "proceed=false" >> $GITHUB_OUTPUT
            echo "::notice::ä¸Šæ¸¸æ— æ›´æ–° - è·³è¿‡åŒæ­¥"
          fi

      # ========== ä»¥ä¸‹æ­¥éª¤ä»…åœ¨éœ€è¦æ—¶æ‰§è¡Œ ==========

      - name: Backup workflow file
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          WORKFLOW_FILE=".github/workflows/Sync QCA Upstream and Apply Modifications.yml"
          if [ -f "$WORKFLOW_FILE" ]; then
            echo "ğŸ“¦ å¤‡ä»½å·¥ä½œæµæ–‡ä»¶åˆ° /tmp..."
            cp "$WORKFLOW_FILE" /tmp/sync-qca-backup.yml
            echo "âœ… å¤‡ä»½å®Œæˆ"
          else
            echo "::error::å·¥ä½œæµæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•å¤‡ä»½"
            exit 1
          fi

      - name: Force sync to upstream (discard all local changes)
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          echo "âš™ï¸ å¼ºåˆ¶åŒæ­¥åˆ°ä¸Šæ¸¸ç‰ˆæœ¬ï¼ˆä¸¢å¼ƒæ‰€æœ‰æœ¬åœ°æ›´æ”¹ï¼‰"
          git checkout main
          git reset --hard upstream/main
          echo "âœ… å·²å®Œå…¨åŒæ­¥åˆ°ä¸Šæ¸¸ç‰ˆæœ¬"
          git log --oneline -3

      - name: Restore workflow file
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          WORKFLOW_FILE=".github/workflows/Sync QCA Upstream and Apply Modifications.yml"
          if [ -f /tmp/sync-qca-backup.yml ]; then
            echo "â™»ï¸ æ¢å¤å·¥ä½œæµæ–‡ä»¶..."
            mkdir -p .github/workflows
            cp /tmp/sync-qca-backup.yml "$WORKFLOW_FILE"
            echo "âœ… å·¥ä½œæµæ–‡ä»¶å·²æ¢å¤"
          else
            echo "::error::æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
            exit 1
          fi

      - name: Step 1 - Add uci-defaults scripts to Settings.sh
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          TARGET="Scripts/Settings.sh"
          
          if [ ! -f "$TARGET" ]; then
            echo "::warning::æ–‡ä»¶ $TARGET ä¸å­˜åœ¨ - è·³è¿‡ä¿®æ”¹"
            exit 0
          fi

          echo "1ï¸âƒ£ åœ¨ Settings.sh æœ«å°¾æ·»åŠ  uci-defaults è„šæœ¬"
          
          if grep -q "LAN IP / Hostname via uci-defaults" "$TARGET"; then
            echo "â„¹ï¸ uci-defaults è„šæœ¬å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "
          else
            {
              echo ""
              echo "#######################################"
              echo "# LAN IP / Hostname via uci-defaults"
              echo "#######################################"
              echo "mkdir -p package/base-files/files/etc/uci-defaults"
              echo "cat << 'EOF' > package/base-files/files/etc/uci-defaults/99-set-lan"
              echo "#!/bin/sh"
              echo "# è®¾ç½® LAN IP"
              echo "uci set network.lan.ipaddr='192.168.1.2'"
              echo "uci set network.lan.netmask='255.255.255.0'"
              echo "# ç¡®ä¿ DHCP æ­£å¸¸"
              echo "uci set dhcp.lan.interface='lan'"
              echo "uci set dhcp.lan.start='100'"
              echo "uci set dhcp.lan.limit='150'"
              echo "uci set dhcp.lan.leasetime='12h'"
              echo "# è®¾ç½®ä¸»æœºå"
              echo "uci set system.@system[0].hostname='ZWRT'"
              echo "uci commit network"
              echo "uci commit dhcp"
              echo "uci commit system"
              echo "exit 0"
              echo "EOF"
              echo "chmod +x package/base-files/files/etc/uci-defaults/99-set-lan"
              echo ""
              echo "#######################################"
              echo "# Fix PPP / UPnP issues"
              echo "#######################################"
              echo "cat << 'EOF' > package/base-files/files/etc/uci-defaults/99-custom-fixes"
              echo "#!/bin/sh"
              echo "sed -i '8c maxfail 1' /etc/ppp/options"
              echo "sed -i '192c sleep 30' /lib/netifd/proto/ppp.sh"
              echo "sed -i '10c option external_ip \"59.111.160.244\"' /etc/config/upnpd"
              echo "exit 0"
              echo "EOF"
              echo "chmod +x package/base-files/files/etc/uci-defaults/99-custom-fixes"
            } >> "$TARGET"
            echo "âœ… uci-defaults è„šæœ¬å·²æ·»åŠ "
          fi

      - name: Step 2 - Remove IPQ807X from CONFIG list
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          TARGET=".github/workflows/QCA-ALL.yml"
          
          if [ ! -f "$TARGET" ]; then
            echo "::warning::æ–‡ä»¶ $TARGET ä¸å­˜åœ¨ - è·³è¿‡ä¿®æ”¹"
            exit 0
          fi

          echo "2ï¸âƒ£ æ³¨é‡Šæ—§CONFIGè¡Œï¼Œæ·»åŠ ä¸å«IPQ807Xçš„æ–°CONFIGè¡Œ"
          
          # æ£€æŸ¥æ˜¯å¦å·²ä¿®æ”¹
          if grep -q "^        #CONFIG:.*IPQ807X" "$TARGET"; then
            echo "â„¹ï¸ CONFIG å·²ä¿®æ”¹ï¼Œè·³è¿‡"
          else
            # ä½¿ç”¨ sed æ³¨é‡Šæ—§è¡Œï¼ˆä¿æŒç¼©è¿›ï¼‰å¹¶åœ¨ä¸‹é¢æ·»åŠ æ–°è¡Œ
            sed -i '/^        CONFIG: \[IPQ60XX.*IPQ807X/s/^        CONFIG:/        #CONFIG:/' "$TARGET"
            sed -i '/^        #CONFIG: \[IPQ60XX.*IPQ807X/a\        CONFIG: [IPQ60XX-WIFI-YES, IPQ60XX-WIFI-NO]' "$TARGET"
            echo "âœ… CONFIG é…ç½®å·²æ›´æ–°ï¼ˆä»…ä¿ç•™ IPQ60XX WIFI é…ç½®ï¼‰"
          fi

      - name: Step 3 - Add device filter to Settings.sh
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          TARGET="Scripts/Settings.sh"
          
          if [ ! -f "$TARGET" ]; then
            echo "::warning::æ–‡ä»¶ $TARGET ä¸å­˜åœ¨ - è·³è¿‡ä¿®æ”¹"
            exit 0
          fi

          echo "3ï¸âƒ£ åœ¨ Settings.sh ä¸­æ·»åŠ è®¾å¤‡è¿‡æ»¤é€»è¾‘"
          
          # æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
          if grep -q "åªä¿ç•™æŒ‡å®šçš„ ipq60xx è®¾å¤‡" "$TARGET"; then
            echo "â„¹ï¸ è®¾å¤‡è¿‡æ»¤é€»è¾‘å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "
          else
            # åœ¨ "#é«˜é€šå¹³å°è°ƒæ•´" å‰é¢æ’å…¥è®¾å¤‡è¿‡æ»¤é€»è¾‘
            awk '
            /#é«˜é€šå¹³å°è°ƒæ•´/ {
              print "# åªä¿ç•™æŒ‡å®šçš„ ipq60xx è®¾å¤‡"
              print "if [[ $WRT_CONFIG == *\"IPQ60XX\"* ]]; then"
              print "    # åªä¿ç•™ï¼š jdcloud_re-ss-01"
              print "    keep_pattern=\"\\(jdcloud_re-ss-01\\)=y$\""
              print "    sed -i \"/^CONFIG_TARGET_DEVICE_qualcommax_ipq60xx_DEVICE_/{"
              print "        /$keep_pattern/!d"
              print "    }\" ./.config"
              print "fi"
              print ""
            }
            { print }
            ' "$TARGET" > "$TARGET.tmp" && mv "$TARGET.tmp" "$TARGET"
            echo "âœ… è®¾å¤‡è¿‡æ»¤é€»è¾‘å·²æ·»åŠ "
          fi

      - name: Step 4 - Add packages to GENERAL.txt
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          TARGET="Config/GENERAL.txt"
          
          if [ ! -f "$TARGET" ]; then
            echo "::warning::æ–‡ä»¶ $TARGET ä¸å­˜åœ¨ - è·³è¿‡ä¿®æ”¹"
            exit 0
          fi

          echo "4ï¸âƒ£ åœ¨ GENERAL.txt ä¸­æ·»åŠ æ’ä»¶é…ç½®"
          
          # æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
          if grep -q "CONFIG_PACKAGE_luci-app-dockerman=y" "$TARGET"; then
            echo "â„¹ï¸ æ’ä»¶é…ç½®å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "
          else
            # ä½¿ç”¨ awk åœ¨ "#åˆ é™¤æ’ä»¶" å‰é¢æ’å…¥é…ç½®ï¼ˆä¸åŠ ç©ºè¡Œï¼‰
            awk '
            /#åˆ é™¤æ’ä»¶/ {
              print "CONFIG_PACKAGE_luci-app-dockerman=y"
              print "CONFIG_PACKAGE_luci-i18n-dockerman-zh-cn=y"
              print "CONFIG_PACKAGE_luci-app-mosdns=y"
              print "CONFIG_PACKAGE_luci-app-lucky=y"
              print "CONFIG_PACKAGE_luci-app-openlist=y"
              print "CONFIG_PACKAGE_nano=y"
            }
            { print }
            ' "$TARGET" > "$TARGET.tmp" && mv "$TARGET.tmp" "$TARGET"
            echo "âœ… æ’ä»¶é…ç½®å·²æ·»åŠ "
          fi
  
      - name: Step 4.5 - Fix mosdns v2ray-geo & CA conflicts (v2ray geodata + ca-certificates)
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          TARGET="Config/GENERAL.txt"

          if [ ! -f "$TARGET" ]; then
            echo "::warning::æ–‡ä»¶ $TARGET ä¸å­˜åœ¨ - è·³è¿‡ mosdns/CA å†²çªä¿®å¤"
            exit 0
          fi

          echo "4ï¸âƒ£â• ç»Ÿä¸€ mosdns ä¾èµ–ä¸º v2ray-geoip+v2ray-geositeï¼Œå¹¶ä½¿ç”¨ ca-certificatesï¼ˆç¦ç”¨ ca-bundle / xray-geodataï¼‰"

          # 1) å…ˆæŠŠå¯èƒ½å­˜åœ¨çš„æ—§é…ç½®è¡Œåˆ æ‰ï¼ˆé¿å… n/y æ··åœ¨ä¸€èµ·ï¼‰
          sed -i '/^#mosdns çš„ v2ray-geo å†²çª + ca-certificates \/ ca-bundle å†²çª$/d' "$TARGET"
          sed -i '/^CONFIG_PACKAGE_v2ray-geoip=/d' "$TARGET"
          sed -i '/^CONFIG_PACKAGE_v2ray-geosite=/d' "$TARGET"
          sed -i '/^CONFIG_PACKAGE_xray-geodata=/d' "$TARGET"
          sed -i '/^CONFIG_PACKAGE_ca-certificates=/d' "$TARGET"
          sed -i '/^CONFIG_PACKAGE_ca-bundle=/d' "$TARGET"

          # 2) è¿½åŠ â€œç‰ˆæœ¬ 2â€çš„æœ€ç»ˆé€‰æ‹©ï¼ˆå¹‚ç­‰ï¼šæ¯æ¬¡è¿è¡Œç»“æœä¸€è‡´ï¼‰
          {
            echo "#mosdns ä½¿ç”¨ v2ray geodata + dockerd ä½¿ç”¨ ca-certificatesï¼ˆé¿å… apk provider å†²çªï¼‰"
            echo "CONFIG_PACKAGE_v2ray-geoip=y"
            echo "CONFIG_PACKAGE_v2ray-geosite=y"
            echo "CONFIG_PACKAGE_xray-geodata=n"
            echo "CONFIG_PACKAGE_ca-certificates=y"
            echo "CONFIG_PACKAGE_ca-bundle=n"
          } >> "$TARGET"

          echo "âœ… å·²å†™å…¥ï¼šv2ray-geoip/geosite=yï¼Œxray-geodata=nï¼Œca-certificates=yï¼Œca-bundle=n"

  
      - name: Step 5 - Add lucky package to Packages.sh
        if: steps.should_proceed.outputs.proceed == 'true'
        run: |
          TARGET="Scripts/Packages.sh"
          
          if [ ! -f "$TARGET" ]; then
            echo "::warning::æ–‡ä»¶ $TARGET ä¸å­˜åœ¨ - è·³è¿‡ä¿®æ”¹"
            exit 0
          fi

          echo "5ï¸âƒ£ åœ¨ Packages.sh ä¸­æ·»åŠ  lucky åŒ…"
          
          # æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
          if grep -q 'UPDATE_PACKAGE "lucky" "gdy666/luci-app-lucky"' "$TARGET"; then
            echo "â„¹ï¸ lucky åŒ…é…ç½®å·²å­˜åœ¨ï¼Œè·³è¿‡æ·»åŠ "
          else
            # åœ¨æ³¨é‡Šè¡Œåé¢æ·»åŠ æ–°è¡Œ
            sed -i '/^# UPDATE_PACKAGE "åŒ…å" "é¡¹ç›®åœ°å€" "é¡¹ç›®åˆ†æ”¯"/a\UPDATE_PACKAGE "lucky" "gdy666/luci-app-lucky" "main"' "$TARGET"
            echo "âœ… lucky åŒ…é…ç½®å·²æ·»åŠ "
          fi

      - name: Commit all changes
        if: steps.should_proceed.outputs.proceed == 'true'
        id: commit_changes
        run: |
          git add -A
          
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "chore: sync upstream and apply QCA custom modifications" \
                       -m "- Synced with upstream/main" \
                       -m "- Added uci-defaults scripts (LAN IP/Hostname & PPP/UPnP fixes)" \
                       -m "- Removed IPQ807X from CONFIG list" \
                       -m "- Added device filter for jdcloud_re-ss-01" \
                       -m "- Added custom packages to GENERAL.txt" \
                       -m "- Added lucky package to Packages.sh" \
                       -m "" \
                       -m "[skip ci]"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… å·²æäº¤æ‰€æœ‰æ›´æ”¹"
          fi

      - name: Push to origin
        if: steps.should_proceed.outputs.proceed == 'true' && steps.commit_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
          git push origin main --force-with-lease || {
            echo "::warning::force-with-lease å¤±è´¥ï¼Œå°è¯• force push..."
            git push origin main --force
          }
          echo "âœ… å·²æˆåŠŸæ¨é€åˆ° origin/main"

      - name: Step 6 - Disable OWRT-ALL workflow
        if: steps.should_proceed.outputs.proceed == 'true'
        env:
          TOKEN: ${{ secrets.PAT_TOKEN != '' && secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          WF_NAME="OWRT-ALL"

          if [ -z "$TOKEN" ]; then
            echo "::warning::æœªæä¾› tokenï¼Œè·³è¿‡ç¦ç”¨å·¥ä½œæµ"
            exit 0
          fi

          echo "ğŸ” æŸ¥æ‰¾å·¥ä½œæµ: $WF_NAME"
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/actions/workflows")
          
          http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE:/d')
          
          if [ "$http_code" != "200" ]; then
            echo "::warning::API è¯·æ±‚å¤±è´¥ (HTTP $http_code)"
            exit 0
          fi

          WF_ID=$(echo "$body" | jq -r ".workflows[] | select(.name==\"${WF_NAME}\") | .id")
          
          if [ -z "$WF_ID" ] || [ "$WF_ID" = "null" ]; then
            echo "::warning::æœªæ‰¾åˆ°å·¥ä½œæµ '$WF_NAME'"
            exit 0
          fi

          echo "æ‰¾åˆ°å·¥ä½œæµ ID: $WF_ID"
          echo "ğŸš« ç¦ç”¨å·¥ä½œæµ..."
          
          disable_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X PUT \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/actions/workflows/${WF_ID}/disable")
          
          disable_code=$(echo "$disable_response" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ "$disable_code" = "204" ]; then
            echo "âœ… å·¥ä½œæµ '$WF_NAME' å·²æˆåŠŸç¦ç”¨"
          else
            echo "::warning::ç¦ç”¨å¤±è´¥ (HTTP $disable_code)"
          fi

      - name: Summary
        if: always()
        run: |
          echo "======================================"
          echo "           æ‰§ è¡Œ æ‘˜ è¦"
          echo "======================================"
          echo ""
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo ""
          
          if [ "${{ steps.should_proceed.outputs.proceed }}" != "true" ]; then
            echo "ğŸ“‹ ç»“æœ: ä¸Šæ¸¸æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
          else
            echo "ğŸ“‹ æ‰§è¡Œç»“æœ:"
            echo "  âœ… å·²å¼ºåˆ¶åŒæ­¥åˆ°ä¸Šæ¸¸ç‰ˆæœ¬"
            echo "  âœ… å·²æ¢å¤å·¥ä½œæµæ–‡ä»¶"
            echo "  âœ… Step 1: æ·»åŠ  uci-defaults è„šæœ¬ (LAN IP/Hostname & PPP/UPnP)"
            echo "  âœ… Step 2: ç§»é™¤ IPQ807X é…ç½®"
            echo "  âœ… Step 3: æ·»åŠ è®¾å¤‡è¿‡æ»¤é€»è¾‘"
            echo "  âœ… Step 4: æ·»åŠ æ’ä»¶åˆ° GENERAL.txt"
            echo "  âœ… Step 4.5: Fix mosdns v2ray-geo & CA conflicts"
            echo "  âœ… Step 5: æ·»åŠ  lucky åŒ…åˆ° Packages.sh"
            echo "  âœ… Step 6: ç¦ç”¨ OWRT-ALL å·¥ä½œæµ"
            
            if [ "${{ steps.commit_changes.outputs.has_changes }}" = "true" ]; then
              echo "  âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€"
            else
              echo "  â„¹ï¸ æ— æ–°æ›´æ”¹éœ€è¦æäº¤"
            fi
          fi
          echo ""
          echo "======================================"
